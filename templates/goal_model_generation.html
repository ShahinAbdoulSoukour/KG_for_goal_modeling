{% extends "base.html" %}

{% block title %} Goal model generation {% endblock %}

{% block content %}
<br>
{% if hierarchy_data %}
<!-- Display the goal model -->
<div id="goal_model_div" style="max-height: 600px; overflow: auto; border: 1px solid #ddd; padding: 10px;"></div>

<br>
<!-- Export buttons -->
<div class="row justify-content-center">
    <!-- <button class="btn btn-info center col col-md-2 mr-2" onclick="downloadOrgChart()">Download goal model as PNG</button> -->
    <button class="btn btn-success center col col-md-2" onclick="downloadJSON()">Download goal model as JSON</button>
</div>
<br>
<!-- TODO: Operation/Agent -->
{% else %}
<div class="alert alert-danger" role="alert">
    No data!
</div>
{% endif %}

{% endblock %}


{% block scripts %}
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript" src=" https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js "></script>

<script type="text/javascript">
    google.charts.load('current', { packages: ["orgchart"] });
    google.charts.setOnLoadCallback(drawChart);

    // Store hierarchy data globally for JSON export
    var globalHierarchyData = null;

    function drawChart() {
        var data = new google.visualization.DataTable();
        data.addColumn('string', 'Name');
        data.addColumn('string', 'Manager');
        data.addColumn('string', 'ToolTip');

        // Get the hierarchy data
        var hierarchyData = {{ hierarchy_data | tojson
    }};
    globalHierarchyData = hierarchyData; // Store for JSON export

    // Collect all high-level goal IDs to determine leaf nodes
    var highLevelGoalIds = new Set();
    hierarchyData.forEach(function (item) {
        highLevelGoalIds.add(item.high_level_goal_id);
    });

    // Track refinement nodes have already been added to the goal model
    var refinementMap = {};

    // Track subgoal nodes that are considered leaf nodes
    var leafNodes = new Set();

    // Create rows for the org chart
    var rows = [];

    hierarchyData.forEach(function (item) {
        var highLevelGoalId = item.high_level_goal_id;
        var subgoalId = item.subgoal_id;

        // Prepare tooltip based on triple_filtered
        var tripleFilteredData = item.triple_filtered ? JSON.parse(item.triple_filtered) : [];

        var tooltipContent = '';
        if (tripleFilteredData.length > 0) {
            tooltipContent = '➕ Add a new subgoal.\n------------------------\nℹ️ Info. selected to create this goal:\n';
            tripleFilteredData.forEach(function (triple) {
                tooltipContent += "• " + triple.replace(/triple/gi, '').replace(/["]/g, '').replace(/[,]/g, '').replace(/['']/g, ' ').trim() + "\n";
            });
        } else {
            tooltipContent = '➕ Add a new subgoal.';
        }

        // Construct the content for subgoal and high-level goal
        var subgoalContent = '[' + item.subgoal_goal_type + '] ' + '<a href="/contextualization/' + subgoalId + '">' + item.subgoal_name + '</a>';
        var highLevelGoalContent = item.high_level_goal_name ? '[' + item.high_level_goal_goal_type + '] ' + '<a href="/contextualization/' + highLevelGoalId + '">' + item.high_level_goal_name + '</a>' : null;

        // Check if this refinement node already exists
        var refinementNode = item.refinement ? item.refinement + ' (' + item.hierarchy_id + ')' : null;

        // Determine if this subgoal is a leaf node
        var isLeaf = !highLevelGoalIds.has(subgoalId);

        // Add delete button to each leaf goals
        if (isLeaf) {
            subgoalContent += ' <span style="white-space: nowrap;">' +
                '<form method="POST" action="/goal_model_generation" style="display:inline;" onsubmit="return confirm(\'Are you sure you want to delete this subgoal?\');">' +
                '<input type="hidden" name="subgoal_id" value="' + item.subgoal_id + '">' +
                '<button type="submit" class="btn btn-outline-danger" title="❌ Delete this leaf goal" >' +
                '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">' +
                '<path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/>' +
                '<path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/>' +
                '</svg>' +
                '</button>' +
                '</form>' +
                '</span>';
        }

        if (item.refinement) {
            var refinementKey = item.refinement + ' (' + highLevelGoalId + ')';

            if (!refinementMap[refinementKey]) {
                refinementMap[refinementKey] = refinementNode;

                rows.push([
                    {
                        'v': refinementNode,
                        'f': '<div class="refinement-node" style="background-color: #e0e0e0;">' +
                            item.refinement +
                            '<span style="white-space: nowrap;">' +
                            '<a type="button" class="btn btn-outline-success" href="/middle_goal/' + highLevelGoalId + '?refinement_type=' + item.refinement + '" data-toggle="tooltip" data-placement="bottom" title="➕ Add intermediary goal">' +
                            '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-lg" viewBox="0 0 16 16">' +
                            '<path fill-rule="evenodd" d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2"/>' +
                            '</svg>' +
                            '</a>' +
                            '</span>' +
                            '</div>'
                    },
                    highLevelGoalContent,
                    'Refinement: ' + item.refinement
                ]);
            }

            rows.push([
                { 'v': subgoalContent, 'f': subgoalContent },
                refinementMap[refinementKey],
                tooltipContent
            ]);

            leafNodes.add(subgoalContent);

        } else {
            rows.push([
                { 'v': subgoalContent, 'f': subgoalContent },
                highLevelGoalContent,
                tooltipContent
            ]);

            leafNodes.add(subgoalContent);
        }
    });

    rows = rows.filter(function (row) {
        return !(leafNodes.has(row[0].v) && refinementMap[row[0].v]);
    });

    data.addRows(rows);

    var chart = new google.visualization.OrgChart(document.getElementById('goal_model_div'));
    chart.draw(data, { 'allowHtml': true });
    }

    /*
    function downloadOrgChart() {
        const chartDiv = $('#goal_model_div')[0];

        html2canvas(chartDiv).then(canvas => {
            const link = document.createElement('a');
            link.download = 'goalmodel.png';
            link.href = canvas.toDataURL();
            link.click();
        });
    }
    */

    function buildHierarchicalJSON(hierarchyData) {
        if (!hierarchyData || hierarchyData.length === 0) {
            return null;
        }

        // Create a map of goals by ID
        const goalsMap = {};
        const goalChildren = {};

        // First pass: collect all unique goals
        hierarchyData.forEach(item => {
            // Add high-level goal if not exists
            if (item.high_level_goal_id && !goalsMap[item.high_level_goal_id]) {
                goalsMap[item.high_level_goal_id] = {
                    goal_id: item.high_level_goal_id.toString(),
                    goal_type: item.high_level_goal_goal_type || "ACHIEVE",
                    label: item.high_level_goal_name
                };
            }

            // Add subgoal if not exists
            if (item.subgoal_id && !goalsMap[item.subgoal_id]) {
                const info = [];
                if (item.triple_filtered) {
                    try {
                        const triples = JSON.parse(item.triple_filtered);
                        triples.forEach(triple => {
                            const cleaned = triple
                                .replace(/triple/gi, '')
                                .replace(/["]/g, '')
                                .replace(/[,]/g, '')
                                .replace(/['']/g, ' ')
                                .trim();
                            if (cleaned) {
                                info.push(cleaned);
                            }
                        });
                    } catch (e) {
                        console.error('Error parsing triple_filtered:', e);
                    }
                }

                goalsMap[item.subgoal_id] = {
                    goal_id: item.subgoal_id.toString(),
                    goal_type: item.subgoal_goal_type || "ACHIEVE",
                    label: item.subgoal_name
                };

                if (info.length > 0) {
                    goalsMap[item.subgoal_id].info = info;
                }
            }

            // Track parent-child relationships
            if (item.high_level_goal_id && item.subgoal_id) {
                if (!goalChildren[item.high_level_goal_id]) {
                    goalChildren[item.high_level_goal_id] = {
                        refinements: {}
                    };
                }

                const refinement = item.refinement || "DIRECT";
                if (!goalChildren[item.high_level_goal_id].refinements[refinement]) {
                    goalChildren[item.high_level_goal_id].refinements[refinement] = [];
                }

                goalChildren[item.high_level_goal_id].refinements[refinement].push(item.subgoal_id);
            }
        });

        // Find root goal (goal that is never a subgoal)
        const allSubgoalIds = new Set();
        hierarchyData.forEach(item => {
            if (item.subgoal_id) {
                allSubgoalIds.add(item.subgoal_id);
            }
        });

        let rootGoalId = null;
        for (const goalId in goalsMap) {
            if (!allSubgoalIds.has(parseInt(goalId))) {
                rootGoalId = goalId;
                break;
            }
        }

        // Fallback: if no root found, use first high-level goal or any goal
        if (!rootGoalId) {
            if (hierarchyData.length > 0 && hierarchyData[0].high_level_goal_id) {
                rootGoalId = hierarchyData[0].high_level_goal_id.toString();
            } else if (Object.keys(goalsMap).length > 0) {
                rootGoalId = Object.keys(goalsMap)[0];
            }
        }

        // If still no root goal found, return null
        if (!rootGoalId || !goalsMap[rootGoalId]) {
            console.error('No valid root goal found');
            return null;
        }

        // Recursive function to build the tree
        function buildGoalTree(goalId) {
            const goal = { ...goalsMap[goalId] };

            if (goalChildren[goalId]) {
                const refinements = goalChildren[goalId].refinements;
                const refinementTypes = Object.keys(refinements);

                if (refinementTypes.length > 0) {
                    // Use the most common refinement type, or first one
                    const mainRefinement = refinementTypes[0];
                    goal.refinement = mainRefinement === "DIRECT" ? "AND" : mainRefinement;

                    const subgoals = [];
                    refinementTypes.forEach(refinementType => {
                        refinements[refinementType].forEach(childId => {
                            const childGoal = buildGoalTree(childId);
                            subgoals.push(childGoal);
                        });
                    });

                    if (subgoals.length > 0) {
                        goal.subgoals = subgoals;
                    }
                }
            }

            return goal;
        }

        const rootGoal = buildGoalTree(rootGoalId);

        return {
            goal_model: {
                root_goal: rootGoal
            }
        };
    }

    function downloadJSON() {
        if (!globalHierarchyData) {
            alert('No data available to download');
            return;
        }

        // Build hierarchical structure
        const hierarchicalJSON = buildHierarchicalJSON(globalHierarchyData);

        if (!hierarchicalJSON) {
            alert('Unable to generate hierarchical JSON');
            return;
        }

        // Convert to JSON string with pretty formatting
        const jsonString = JSON.stringify(hierarchicalJSON, null, 2);

        // Create blob and download
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.download = 'goalmodel.json';
        link.href = url;
        link.click();
        URL.revokeObjectURL(url);
    }

    $(document).ready(function () {
        $('#visualizationNav a').addClass('active')
        $('[data-toggle="tooltip"]').tooltip({ "html": true, "placement": "bottom", "trigger": "hover" })
        $('[data-toggle="tooltip"]').click(function () {
            $('[data-toggle="tooltip"]').tooltip("hide", { "html": true, "placement": "bottom", "trigger": "hover" })
        })
    })
</script>
{% endblock %}